<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIRO-TECH // OPERATING SYSTEM V11.19</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Jitsi Meet API for Voice Rooms -->
    <script src="https://meet.jit.si/external_api.js"></script>
    
    <style>
        :root {
            /* Light Mode (Default) */
            --bg-color: #f2f2f2;
            --panel-bg: #ffffff;
            --text-main: #0a0a0a;
            --text-inv: #ffffff;
            --text-dim: #555555;
            --accent: #000000;
            --accent-inv: #ffffff;
            --alert: #ff2a2a;
            --google-blue: #4285F4;
            --link-color: #0066cc;
            --input-bg: #f0f0f0;
            --border-thick: 3px solid var(--accent);
            --border-thin: 1px solid var(--accent);
            --font-tech: 'Share Tech Mono', monospace;
            --font-display: 'Rajdhani', sans-serif;
            --font-jp: 'Noto Sans JP', sans-serif;
        }

        /* Dark Mode Variables */
        body.dark-theme {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-inv: #0a0a0a;
            --text-dim: #888888;
            --accent: #ffffff;
            --accent-inv: #000000;
            --alert: #ff5555;
            --google-blue: #5e9eff;
            --link-color: #4da6ff;
            --input-bg: #2a2a2a;
        }

        * {
            box-sizing: border-box;
            cursor: crosshair;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-color);
        }

        /* Scrollbar custom */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--accent); border: 1px solid var(--panel-bg); }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-tech);
            margin: 0;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            background-image: 
                linear-gradient(rgba(128, 128, 128, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(128, 128, 128, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s, color 0.3s;
        }

        /* --- VIEW CONTROLS --- */
        .view-controls {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel-bg);
            border: 1px solid var(--accent);
            border-top: none;
            padding: 5px 15px;
            z-index: 9000;
            border-radius: 0 0 10px 10px;
            display: flex;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .view-btn {
            background: transparent;
            border: 1px solid transparent;
            font-family: var(--font-display);
            font-weight: bold;
            cursor: pointer;
            padding: 2px 8px;
            font-size: 0.9rem;
            transition: 0.2s;
            color: var(--text-main);
        }
        .view-btn:hover { background: var(--bg-color); }
        .view-btn.active { background: var(--accent); color: var(--accent-inv); }

        /* --- MOBILE MODE STYLES --- */
        body.mobile-mode {
            background-color: #050505;
            padding: 0;
        }
        
        body.mobile-mode .main-container {
            max-width: 420px;
            width: 100%;
            height: 100%;
            border: none;
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
            gap: 10px;
            padding: 10px;
            grid-template-columns: 1fr; 
            grid-template-rows: auto;
        }

        body.mobile-mode header { padding: 10px; flex-shrink: 0; }
        body.mobile-mode .brand-title { font-size: 2rem; }
        body.mobile-mode .header-stats { display: none; }
        
        body.mobile-mode .sidebar {
            flex-direction: row;
            overflow-x: auto;
            overflow-y: hidden;
            height: auto;
            flex-shrink: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }
        body.mobile-mode .nav-btn { min-width: 140px; padding: 10px; font-size: 0.9rem; }
        body.mobile-mode .right-panel { display: none !important; }
        body.mobile-mode .content-area { flex-grow: 1; padding: 15px; }
        body.mobile-mode .bottom-bar { flex-shrink: 0; display: flex; height: auto; padding: 5px 0; gap: 5px; }
        body.mobile-mode .log-terminal, body.mobile-mode .warning-box { display: none; }

        /* --- LOADING ANIMATION --- */
        #boot-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; pointer-events: none;
            display: flex; justify-content: center; align-items: center;
        }
        .cine-bar {
            position: absolute; left: 0; width: 100%; height: 51vh;
            background: #0a0a0a; z-index: 10000;
            transition: transform 0.8s cubic-bezier(0.8, 0, 0.1, 1);
        }
        .bar-top { top: 0; transform-origin: top; border-bottom: 2px solid var(--alert); }
        .bar-bottom { bottom: 0; transform-origin: bottom; border-top: 2px solid var(--alert); }
        #boot-overlay.loaded .bar-top { transform: translateY(-100%); }
        #boot-overlay.loaded .bar-bottom { transform: translateY(100%); }
        #boot-overlay.loaded .boot-content { opacity: 0; transition: opacity 0.3s; }

        .boot-content { z-index: 10001; color: #fff; text-align: center; position: relative; width: 100%; max-width: 600px; }
        .boot-logo { font-family: var(--font-display); font-size: 5rem; font-weight: 800; letter-spacing: -2px; line-height: 1; margin-bottom: 10px; transform: scale(0.9); animation: pulse-logo 0.1s infinite alternate; }
        .boot-sub { font-family: var(--font-tech); letter-spacing: 5px; font-size: 1rem; color: var(--alert); margin-bottom: 30px; }
        .boot-progress-container { width: 100%; height: 4px; background: #333; position: relative; overflow: hidden; margin-bottom: 10px; }
        .boot-progress-bar { height: 100%; width: 0%; background: #fff; animation: load-progress 2.5s cubic-bezier(0.1, 0.9, 0.2, 1) forwards; }
        .boot-terminal { font-family: 'Consolas', monospace; font-size: 0.8rem; text-align: left; color: #888; height: 100px; overflow: hidden; border-left: 2px solid #fff; padding-left: 10px; }
        .scanline { position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: rgba(255, 255, 255, 0.5); opacity: 0.5; animation: scan 2s linear infinite; z-index: 10002; pointer-events: none; }

        @keyframes load-progress { 0% { width: 0%; } 20% { width: 10%; } 40% { width: 45%; } 60% { width: 60%; } 80% { width: 90%; } 100% { width: 100%; } }
        @keyframes pulse-logo { from { text-shadow: 2px 0 var(--alert), -2px 0 blue; opacity: 1; } to { text-shadow: -2px 0 var(--alert), 2px 0 blue; opacity: 0.8; } }
        @keyframes scan { 0% { top: -10%; } 100% { top: 110%; } }

        /* --- IDENTITY OVERLAY --- */
        #identity-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.98); z-index: 12000; 
            display: none; justify-content: center; align-items: center; 
        }
        body.dark-theme #identity-overlay { background: rgba(10,10,10,0.98); }
        #identity-overlay.active { display: flex; }
        .identity-card { 
            background: var(--panel-bg); color: var(--text-main);
            border: 4px solid var(--accent); padding: 30px; 
            width: 90%; max-width: 400px; 
            box-shadow: 10px 10px 0px rgba(0,0,0,0.2); text-align: center; 
        }
        .id-input-group { margin-bottom: 20px; text-align: left; }
        .id-input-group label { display: block; font-weight: bold; margin-bottom: 5px; font-family: var(--font-display); }

        .google-btn {
            background: var(--google-blue); color: #fff; border: none;
            width: 100%; padding: 12px; font-size: 1rem; font-weight: bold;
            font-family: var(--font-display); cursor: pointer;
            margin-bottom: 15px; display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: 0.2s;
        }
        .google-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 0 rgba(0,0,0,0.2); }
        .google-btn:active { transform: translateY(2px); box-shadow: none; }
        
        .divider { border-bottom: 1px dashed var(--text-dim); height: 1px; margin: 20px 0; position: relative; }
        .divider span { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--panel-bg); padding: 0 10px; color: var(--text-dim); font-size: 0.8rem; }

        /* --- PROFILE MODAL --- */
        #profile-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 11000; display: none; justify-content: center; align-items: center; }
        #profile-modal.active { display: flex; }
        .profile-card-display { background: var(--panel-bg); color: var(--text-main); border: 2px solid var(--accent); width: 350px; position: relative; overflow: hidden; }
        .profile-header-bg { height: 100px; background: repeating-linear-gradient(45deg, var(--accent), var(--accent) 10px, #333 10px, #333 20px); }
        .profile-avatar-large { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--panel-bg); background: #ccc; margin: -50px auto 10px; position: relative; overflow: hidden; background-size: cover; background-position: center; }
        .profile-details { padding: 20px; text-align: center; }
        .profile-name-large { font-family: var(--font-display); font-size: 2rem; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; display: flex; justify-content: center; align-items: center; gap: 5px;}
        .profile-bio { color: var(--text-dim); font-size: 0.9rem; line-height: 1.4; margin-bottom: 20px; border-top: 1px dashed #ccc; border-bottom: 1px dashed #ccc; padding: 10px 0; }
        .close-modal-btn { position: absolute; top: 10px; right: 10px; background: var(--panel-bg); border: 1px solid var(--accent); cursor: pointer; color: var(--text-main); width: 30px; height: 30px; font-weight: bold; }
        .verified-badge { color: var(--google-blue); font-size: 0.6em; vertical-align: middle; }

        /* --- IMAGE VIEWER MODAL --- */
        #image-viewer-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 15000;
            display: none; justify-content: center; align-items: center;
            flex-direction: column;
        }
        #image-viewer-modal.active { display: flex; }
        #image-viewer-img { max-width: 90%; max-height: 80%; border: 2px solid var(--accent); box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .image-viewer-close { margin-top: 20px; background: #000; color: #fff; border: 2px solid #fff; padding: 10px 20px; cursor: pointer; font-family: var(--font-display); }

        /* --- STICKER & REACTION MODALS --- */
        #sticker-modal, #reaction-picker {
            position: absolute; bottom: 70px; right: 10px;
            width: 280px; height: auto; max-height: 320px;
            background: var(--panel-bg);
            border: 2px solid var(--accent);
            display: none; flex-direction: column;
            z-index: 5000;
            box-shadow: -5px 5px 0 rgba(0,0,0,0.2);
        }
        #reaction-picker { height: auto; padding: 10px; display: none; flex-wrap: wrap; gap: 5px; justify-content: center; bottom: unset; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 220px; }
        #sticker-modal.active, #reaction-picker.active { display: flex; }
        .sticker-header { padding: 10px; border-bottom: 1px solid var(--accent); font-weight: bold; display: flex; justify-content: space-between; align-items: center; color: var(--text-main); }
        .sticker-grid { flex-grow: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .sticker-option { width: 100%; aspect-ratio: 1; object-fit: contain; border: 1px dashed var(--text-dim); cursor: pointer; border-radius: 5px; background: var(--bg-color); }
        .sticker-option:hover { border: 1px solid var(--accent); }
        .sticker-actions { padding: 10px; border-top: 1px solid var(--accent); text-align: center; }
        
        .chat-sticker { max-width: 120px; height: auto; display: block; cursor: pointer; transition: transform 0.1s; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        .chat-sticker:hover { transform: scale(1.05); }
        .chat-bubble.sticker-msg { background: transparent !important; border: none !important; box-shadow: none !important; padding: 0; }

        .reaction-btn-emoji { font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 5px; transition: 0.2s; background: var(--bg-color); border: 1px solid transparent; }
        .reaction-btn-emoji:hover { background: var(--accent); border-color: var(--accent-inv); }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .glitch-effect:hover { animation: glitch-anim 0.3s cubic-bezier(.25, .46, .45, .94) both infinite; color: var(--alert); }
        @keyframes glitch-anim { 0% { transform: translate(0) } 20% { transform: translate(-2px, 2px) } 40% { transform: translate(-2px, -2px) } 60% { transform: translate(2px, 2px) } 80% { transform: translate(2px, -2px) } 100% { transform: translate(0) } }
        .clipped-box { background: var(--panel-bg); border: var(--border-thick); clip-path: polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%); position: relative; }
        .barcode { height: 30px; width: 100%; background-image: linear-gradient(90deg, var(--accent) 0%, var(--accent) 5%, transparent 5%, transparent 10%, var(--accent) 10%, var(--accent) 15%, transparent 15%, transparent 17%, var(--accent) 17%, var(--accent) 22%, transparent 22%, transparent 25%, var(--accent) 25%, var(--accent) 35%, transparent 35%, transparent 40%, var(--accent) 40%, var(--accent) 45%, transparent 45%, transparent 50%, var(--accent) 50%, var(--accent) 60%, transparent 60%, transparent 70%, var(--accent) 70%, var(--accent) 80%, transparent 80%, transparent 85%, var(--accent) 85%, var(--accent) 100% ); opacity: 0.8; }

        /* --- LAYOUT --- */
        .main-container { width: 100%; max-width: 1600px; height: 95vh; display: grid; grid-template-columns: 260px 1fr 300px; grid-template-rows: 80px 1fr 150px; gap: 15px; transition: all 0.3s; }

        /* --- HEADER --- */
        header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; border-bottom: var(--border-thick); padding: 0 20px; background: var(--panel-bg); position: relative; }
        header::after { content: ''; position: absolute; bottom: -8px; right: 0; width: 100px; height: 5px; background: var(--accent); }
        .brand-title { font-family: var(--font-display); font-size: 3rem; font-weight: 700; letter-spacing: -2px; text-transform: uppercase; line-height: 0.8; }
        .brand-subtitle { font-size: 0.8rem; letter-spacing: 2px; color: var(--text-dim); }
        .clock-display { font-size: 2rem; font-weight: bold; font-family: var(--font-tech); border: 1px solid var(--accent); padding: 0 15px; background: var(--bg-color); margin-right: 20px; }
        .header-stats { display: flex; gap: 20px; text-align: right; font-size: 0.75rem; align-items: center;}
        .jp-sub { display: block; font-family: var(--font-jp); font-size: 0.7em; opacity: 0.6; margin-top: -2px; }

        /* --- SIDEBAR --- */
        .sidebar { grid-row: 2 / 3; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; padding-right: 5px; }
        .nav-btn { background: var(--panel-bg); border: 1px solid var(--accent); padding: 12px; font-family: var(--font-display); font-weight: 700; font-size: 1rem; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; position: relative; flex-shrink: 0; color: var(--text-main); }
        .nav-btn:hover, .nav-btn.active { background: var(--accent); color: var(--accent-inv); padding-left: 20px; }
        .nav-btn .decor-icon { font-size: 1.2rem; }

        /* --- MAIN CONTENT AREA --- */
        .content-area { grid-column: 2 / 3; grid-row: 2 / 3; position: relative; background: var(--panel-bg); padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .content-area::before { content: '+'; position: absolute; top: 10px; left: 10px; font-weight: bold; }
        .content-area::after { content: '+'; position: absolute; top: 10px; right: 10px; font-weight: bold; }
        .app-view { height: 100%; display: flex; flex-direction: column; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Input Styles */
        input[type="text"], input[type="number"], textarea { background: var(--input-bg); border: 1px solid var(--accent); color: var(--text-main); font-family: var(--font-tech); padding: 10px; font-size: 1rem; width: 100%; outline: none; }
        input:focus, textarea:focus { background: var(--panel-bg); border-left: 5px solid var(--accent); }
        button.action-btn { background: var(--panel-bg); border: 2px solid var(--accent); color: var(--text-main); padding: 5px 15px; font-family: var(--font-display); font-weight: bold; text-transform: uppercase; transition: 0.2s; cursor: pointer; }
        button.action-btn:hover { background: var(--accent); color: var(--accent-inv); }

        /* --- CHAT STYLES --- */
        .chat-container { flex-grow: 1; border: 2px solid var(--accent); background: var(--bg-color); color: var(--text-main); padding: 20px; overflow-y: auto; font-family: var(--font-tech); margin-bottom: 10px; display: flex; flex-direction: column; gap: 15px; }
        .chat-row { display: flex; width: 100%; margin-bottom: 5px; align-items: flex-end; gap: 8px; position: relative; }
        .chat-row.self { flex-direction: row-reverse; }
        .chat-avatar-small { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--accent); background-size: cover; background-position: center; background-color: #ddd; cursor: pointer; flex-shrink: 0; }
        .chat-msg-content { display: flex; flex-direction: column; max-width: 70%; position: relative; }
        .chat-row.self .chat-msg-content { align-items: flex-end; }
        .chat-row.other .chat-msg-content { align-items: flex-start; }
        .chat-meta { font-size: 0.7em; color: var(--text-dim); margin-bottom: 2px; padding: 0 5px; font-weight: bold; display: flex; gap: 5px; align-items: center; }
        .chat-bubble { padding: 10px 15px; position: relative; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; box-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        .chat-row.self .chat-bubble { background: var(--accent); color: var(--accent-inv); border-radius: 12px 12px 0 12px; text-align: right; }
        .chat-row.other .chat-bubble { background: var(--panel-bg); color: var(--text-main); border: 1px solid var(--accent); border-radius: 12px 12px 12px 0; text-align: left; }
        .chat-link { color: var(--link-color); text-decoration: underline; font-weight: bold; }
        
        .chat-controls { display: flex; gap: 10px; background: var(--bg-color); padding: 10px; border: 1px solid var(--accent); align-items: center; }
        #chat-input { border-radius: 20px; border: 1px solid #999; padding: 10px 15px; }
        .chat-send-btn { background: var(--accent); color: var(--accent-inv); border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; cursor: pointer; transition: transform 0.1s; }
        .chat-send-btn:active { transform: scale(0.9); }
        
        .chat-image { max-width: 200px; border-radius: 5px; margin: 5px 0; display: block; cursor: pointer; border: 2px solid var(--text-dim); background: #000; }
        .chat-file-card { background: var(--bg-color); border: 1px dashed var(--accent); padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; align-items: center; gap: 10px; text-decoration: none; color: var(--text-main); cursor: pointer; }
        .chat-file-card:hover { background: var(--panel-bg); }
        .chat-file-icon { font-size: 1.5rem; }
        .chat-file-info { display: flex; flex-direction: column; font-size: 0.8rem; }
        .chat-audio-player { width: 100%; margin-top: 5px; }

        .chat-upload-btn, .chat-mic-btn { background: var(--panel-bg); color: var(--text-main); border: 1px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; cursor: pointer; transition: transform 0.1s; flex-shrink: 0; }
        .chat-upload-btn:active, .chat-mic-btn:active { transform: scale(0.9); }
        .chat-mic-btn.recording { background: var(--alert); color: #fff; animation: pulse-logo 1s infinite; border-color: var(--alert); }

        /* Message Options (Delete/Edit) */
        .msg-options-btn {
            background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-size: 1rem; opacity: 0; transition: 0.2s;
        }
        .chat-row:hover .msg-options-btn { opacity: 1; }
        .msg-options-menu {
            position: absolute; top: 100%; right: 0; background: var(--panel-bg); border: 1px solid var(--accent); 
            z-index: 100; display: none; flex-direction: column; min-width: 100px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .msg-options-menu.active { display: flex; }
        .msg-option { padding: 8px 12px; cursor: pointer; text-align: left; font-size: 0.8rem; color: var(--text-main); }
        .msg-option:hover { background: var(--bg-color); }
        .msg-option.delete { color: var(--alert); }

        /* Reactions */
        .reaction-bar { display: flex; gap: 5px; margin-top: 5px; }
        .reaction-pill { 
            background: var(--bg-color); border: 1px solid var(--accent); border-radius: 10px; 
            padding: 2px 6px; font-size: 0.75rem; display: flex; align-items: center; gap: 3px; cursor: pointer;
        }
        .reaction-pill:hover { background: var(--accent); color: var(--accent-inv); }
        .add-reaction-btn { opacity: 0; transition: 0.2s; cursor: pointer; font-size: 1rem; margin-left: 5px; }
        .chat-row:hover .add-reaction-btn { opacity: 1; }

        /* Read Receipt */
        .read-receipt { font-size: 0.7em; color: var(--text-dim); display: flex; align-items: center; gap: 3px; margin-left: 5px; }
        .read-receipt.active { color: #00aa00; }

        /* --- VOX (VOICE) STYLES - DISCORD STYLE --- */
        .voice-wrapper { display: flex; flex-direction: row; height: 100%; border: 2px solid var(--accent); background: #111; }
        .voice-sidebar { width: 200px; background: #222; border-right: 1px solid var(--accent); display: flex; flex-direction: column; padding: 10px; }
        .voice-channel-item { padding: 10px; margin-bottom: 5px; background: #333; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 8px; border-radius: 4px; border: 1px solid transparent; font-size: 0.9rem; }
        .voice-channel-item:hover { background: #444; border-color: #666; }
        .voice-channel-item.active { background: var(--accent); color: var(--accent-inv); border-color: #fff; }
        .voice-channel-item span { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .voice-channel-item.active span { background: #0f0; box-shadow: 0 0 5px #0f0; }
        
        .voice-main { flex-grow: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        .voice-stage { flex-grow: 1; width: 100%; height: 100%; overflow: hidden; position: relative; }
        /* Style adjustments for VDO.Ninja iframe */
        .voice-stage iframe { width: 100%; height: 100%; border: none; filter: grayscale(100%) contrast(1.1); }
        
        .voice-controls { height: 60px; background: #1a1a1a; border-top: 1px solid var(--accent); display: flex; justify-content: center; align-items: center; gap: 15px; }
        .voice-btn { width: 45px; height: 45px; border-radius: 50%; background: #333; border: none; color: #fff; font-size: 1.2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .voice-btn:hover { background: #555; }
        .voice-btn.active { background: #fff; color: #000; }
        .voice-btn.danger { background: var(--alert); }

        /* Other Modules Styles */
        #notepad-area { resize: none; flex-grow: 1; margin-top: 10px; font-size: 1.1rem; line-height: 1.4; border: 1px dashed #999; }
        .code-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        #code-editor { resize: none; flex-grow: 1; background: #1a1a1a; color: #0f0; font-family: 'Consolas', monospace; border: 2px solid var(--accent); padding: 15px; tab-size: 4; }
        .viz-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 1px dashed var(--accent); position: relative; background: #000; overflow: hidden; }
        canvas#viz-canvas { width: 100%; height: 100%; object-fit: cover; }
        .song-title { position: absolute; top: 20px; left: 20px; font-size: 3rem; color: rgba(255,255,255,0.2); pointer-events: none; white-space: nowrap; overflow: hidden; max-width: 90%; z-index: 2; }
        .viz-controls { margin-top: 10px; display: flex; gap: 10px; align-items: center; }
        .paint-toolbar { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; background: var(--bg-color); padding: 5px; border: 1px solid var(--accent); }
        .canvas-wrapper { flex-grow: 1; border: 2px solid var(--accent); background: url('data:image/svg+xml;utf8,<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="10" height="10" fill="%23eee"/><rect x="10" y="10" width="10" height="10" fill="%23eee"/></svg>'); overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; }
        #paint-canvas { display: block; }
        .link-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .link-btn { height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-decoration: none; border: 2px solid var(--accent); color: var(--text-main); transition: 0.2s; position: relative; overflow: hidden; }
        .link-btn:hover { background: var(--accent); color: var(--accent-inv); transform: translateY(-3px); box-shadow: 4px 4px 0 rgba(0,0,0,0.2); }
        .link-del { position: absolute; top: 0; right: 0; background: var(--alert); color: #fff; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; cursor: pointer; }
        .calc-wrapper { max-width: 300px; margin: 0 auto; border: 3px solid var(--accent); padding: 10px; background: var(--bg-color); }
        .calc-screen { width: 100%; height: 60px; background: #aebcbf; border: 2px solid #555; margin-bottom: 10px; font-size: 2rem; text-align: right; padding: 10px; font-family: 'Consolas', monospace; overflow: hidden; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1); color: #000; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .calc-btn { height: 50px; background: var(--panel-bg); border: 1px solid var(--accent); font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.1s; font-family: var(--font-display); color: var(--text-main); }
        .calc-btn:active { background: var(--accent); color: var(--accent-inv); }
        .calc-btn.op { background: var(--bg-color); }
        .calc-btn.eq { background: var(--accent); color: var(--accent-inv); }
        .piano-wrapper { flex-grow: 1; display: flex; justify-content: center; align-items: flex-end; padding: 20px; background: #222; border: 2px solid var(--accent); overflow-x: auto; }
        .key { width: 40px; height: 200px; background: #fff; border: 1px solid #000; margin: 0 2px; position: relative; cursor: pointer; border-radius: 0 0 5px 5px; transition: 0.1s; }
        .key:active, .key.active { background: #ddd; transform: translateY(2px); height: 198px; box-shadow: inset 0 -5px 10px rgba(0,0,0,0.2); }
        .key.black { width: 26px; height: 120px; background: #000; position: absolute; margin-left: -13px; z-index: 2; border: 1px solid #444; }
        .key.black:active, .key.black.active { background: #333; }
        .key-label { position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 0.7rem; color: #aaa; pointer-events: none; }

        /* --- RIGHT PANEL --- */
        .right-panel { grid-row: 2 / 3; display: flex; flex-direction: column; gap: 15px; }
        .stat-card { background: var(--panel-bg); border: 2px solid var(--accent); padding: 10px; position: relative; }
        .stat-card h3 { margin: 0 0 5px 0; font-size: 0.9rem; text-transform: uppercase; border-bottom: 1px solid var(--accent); display: flex; justify-content: space-between; }
        .progress-bar { height: 15px; background: var(--bg-color); margin-top: 5px; position: relative; overflow: hidden; }
        .fill { height: 100%; background: repeating-linear-gradient(45deg, var(--accent), var(--accent) 5px, var(--panel-bg) 5px, var(--panel-bg) 10px); width: 70%; animation: fill-anim 2s infinite linear; }
        @keyframes fill-anim { 0% { background-position: 0 0; } 100% { background-position: 50px 0; } }

        /* --- BOTTOM BAR --- */
        .bottom-bar { grid-column: 1 / -1; grid-row: 3 / 4; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: center; }
        .log-terminal { background: #000; color: #fff; height: 100%; padding: 10px; font-size: 0.8rem; overflow: hidden; font-family: 'Consolas', monospace; position: relative; border: 1px solid var(--accent); }
        .warning-box { border: 2px solid var(--alert); height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: repeating-linear-gradient(45deg, var(--panel-bg), var(--panel-bg) 10px, rgba(255,42,42,0.1) 10px, rgba(255,42,42,0.1) 20px); color: var(--alert); font-weight: bold; text-transform: uppercase; }

        /* --- VERTICAL TEXT --- */
        .vert-text { writing-mode: vertical-rl; text-orientation: mixed; position: absolute; right: 0; top: 50%; transform: translateY(-50%); font-family: var(--font-jp); font-weight: 900; font-size: 2rem; opacity: 0.1; pointer-events: none; line-height: 1; z-index: 0; color: var(--text-main); }
        
        .manual-reg-btn { background: var(--alert); color: #fff; border: none; padding: 5px 10px; font-size: 0.7rem; cursor: pointer; margin-left: 10px; display: none; animation: pulse-logo 1s infinite; }
    </style>
</head>
<body>

    <!-- BOOT SEQUENCE OVERLAY -->
    <div id="boot-overlay">
        <div class="cine-bar bar-top"></div>
        <div class="cine-bar bar-bottom"></div>
        <div class="scanline"></div>
        <div class="boot-content">
            <div class="boot-logo">ZENX // SYS</div>
            <div class="boot-sub">INITIALIZING IDENTITY PROTOCOL...</div>
            <div class="boot-progress-container">
                <div class="boot-progress-bar"></div>
            </div>
            <div class="boot-terminal" id="boot-log">
                > CPU... DETECTED<br>
            </div>
        </div>
    </div>

    <!-- VIEW CONTROLS -->
    <div class="view-controls">
        <button class="view-btn active" id="btn-pc" onclick="setViewMode('pc')">MODO PC</button>
        <button class="view-btn" id="btn-mobile" onclick="setViewMode('mobile')">MODO M√ìVIL</button>
        <button class="view-btn" id="btn-theme" onclick="toggleTheme()">MODO OSCURO</button>
    </div>

    <!-- REGISTRATION OVERLAY -->
    <div id="identity-overlay">
        <div class="identity-card">
            <h2 style="font-family: var(--font-display); font-size: 2.5rem; margin-top: 0;">PERSONNEL REGISTRY</h2>
            <p style="color: var(--text-dim); margin-bottom: 20px;">IDENTITY REQUIRED FOR SYSTEM ACCESS</p>
            
            <button class="google-btn" onclick="loginWithGoogle()">
                <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#fff" d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" fill-rule="evenodd" clip-rule="evenodd"></path><path fill="#fff" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z" fill-rule="evenodd" clip-rule="evenodd"></path><path fill="#fff" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill-rule="evenodd" clip-rule="evenodd"></path><path fill="#fff" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                ACCESS VIA GOOGLE NET
            </button>
            
            <div class="divider"><span>OR ANONYMOUS</span></div>

            <div class="id-input-group"><label>CODENAME</label><input type="text" id="reg-username" placeholder="Enter your alias..."></div>
            <div class="id-input-group"><label>AVATAR URL</label><input type="text" id="reg-avatar" placeholder="https://..." value="https://api.dicebear.com/7.x/bottts/svg?seed=shiro"></div>
            <div class="id-input-group"><label>BIO</label><textarea id="reg-bio" rows="3" placeholder="System operator status..."></textarea></div>
            <button class="action-btn" style="width: 100%; padding: 15px; font-size: 1.2rem; background: var(--accent); color: var(--accent-inv);" onclick="registerUser()">CONFIRM IDENTITY</button>
            <p id="reg-error" style="color: red; margin-top: 10px; display: none;">ERROR: FIELDS CANNOT BE EMPTY</p>
        </div>
    </div>

    <!-- PROFILE VIEWER MODAL -->
    <div id="profile-modal" onclick="closeProfileModal(event)">
        <div class="profile-card-display" onclick="event.stopPropagation()">
            <button class="close-modal-btn" onclick="closeProfileModal()">X</button>
            <div class="profile-header-bg"></div>
            <div id="view-avatar" class="profile-avatar-large"></div>
            <div class="profile-details">
                <div id="view-name" class="profile-name-large">UNKNOWN</div>
                <div class="jp-sub" style="margin-bottom: 10px;">ID: <span id="view-id">---</span></div>
                <div id="view-bio" class="profile-bio">No data available.</div>
                <div style="font-size: 0.8rem; color: var(--text-dim);">ZENX SYSTEM // VERIFIED USER</div>
                <div style="margin-top: 10px; font-weight: bold; border-top: 1px solid var(--accent); padding-top: 5px;">
                    DEVICE: <span id="view-device">UNKNOWN</span>
                </div>
            </div>
        </div>
    </div>

    <!-- IMAGE VIEWER MODAL -->
    <div id="image-viewer-modal" onclick="this.classList.remove('active')">
        <img id="image-viewer-img" src="" onclick="event.stopPropagation()">
        <button class="image-viewer-close">CLOSE</button>
    </div>

    <!-- REACTION PICKER -->
    <div id="reaction-picker">
        <div style="width:100%;text-align:right;border-bottom:1px solid #000;margin-bottom:5px;"><button onclick="document.getElementById('reaction-picker').classList.remove('active')" style="background:none;border:none;cursor:pointer;">X</button></div>
        <div class="reaction-btn-emoji" onclick="submitReaction('üëç')">üëç</div>
        <div class="reaction-btn-emoji" onclick="submitReaction('‚ù§Ô∏è')">‚ù§Ô∏è</div>
        <div class="reaction-btn-emoji" onclick="submitReaction('üòÇ')">üòÇ</div>
        <div class="reaction-btn-emoji" onclick="submitReaction('üòÆ')">üòÆ</div>
        <div class="reaction-btn-emoji" onclick="submitReaction('üò¢')">üò¢</div>
        <div class="reaction-btn-emoji" onclick="submitReaction('üò°')">üò°</div>
        <div class="reaction-btn-emoji" onclick="submitReaction('üî•')">üî•</div>
        <div class="reaction-btn-emoji" onclick="submitReaction('‚úÖ')">‚úÖ</div>
    </div>

    <div class="main-container">
        <header>
            <div><div class="brand-title">ZENX // SYSTEM</div><div class="brand-subtitle">VER 11.19.0 // SUITE</div></div>
            <div style="display:flex; align-items:center;">
                <div id="clock" class="clock-display">00:00:00</div>
                <button id="manual-reg-btn" class="manual-reg-btn" onclick="document.getElementById('identity-overlay').classList.add('active')">REGISTRO MANUAL</button>
                <div class="header-stats"><div><div>NET</div><span class="jp-sub">Êé•Á∂ö</span><div style="font-weight:bold" id="net-status">WAITING...</div></div><div class="barcode" style="width: 80px; height: 25px;"></div></div>
            </div>
        </header>

        <aside class="sidebar">
            <button class="nav-btn clipped-box active" onclick="showApp('dashboard')"><div>DASHBOARD <span class="jp-sub">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</span></div><div class="decor-icon">00</div></button>
            <button class="nav-btn clipped-box" onclick="showApp('profile')"><div>IDENTITY <span class="jp-sub">„Éó„É≠„Éï„Ç£„Éº„É´</span></div><div class="decor-icon">ID</div></button>
            <button class="nav-btn clipped-box" onclick="showApp('chat')"><div>COMMS <span class="jp-sub">ÈÄö‰ø°</span></div><div class="decor-icon">09</div></button>
            <button class="nav-btn clipped-box" onclick="showApp('voice')"><div>VOX LINK <span class="jp-sub">Èü≥Â£∞</span></div><div class="decor-icon">üé§</div></button>
            <button class="nav-btn clipped-box" onclick="showApp('notepad')"><div>NOTEPAD <span class="jp-sub">„É°„É¢Â∏≥</span></div><div class="decor-icon">01</div></button>
            <button class="nav-btn clipped-box" onclick="showApp('code')"><div>CODE DEV <span class="jp-sub">„Ç≥„Éº„Éâ</span></div><div class="decor-icon">02</div></button>
            <button class="nav-btn clipped-box" onclick="showApp('music')"><div>AUDIO VIZ <span class="jp-sub">Èü≥Ê•ΩÂèØË¶ñÂåñ</span></div><div class="decor-icon">03</div></button>
            <button class="nav-btn clipped-box" onclick="showApp('paint')"><div>IMG EDIT <span class="jp-sub">ÁîªÂÉèÁ∑®ÈõÜ</span></div><div class="decor-icon">04</div></button>
            <button class="nav-btn clipped-box" onclick="showApp('links')"><div>LINKS <span class="jp-sub">„É™„É≥„ÇØÈõÜ</span></div><div class="decor-icon">05</div></button>
            <button class="nav-btn clipped-box" onclick="showApp('calc')"><div>CALC <span class="jp-sub">Ë®àÁÆóÊ©ü</span></div><div class="decor-icon">06</div></button>
            <button class="nav-btn clipped-box" onclick="showApp('piano')"><div>SYNTH <span class="jp-sub">„Éî„Ç¢„Éé</span></div><div class="decor-icon">07</div></button>
        </aside>

        <main class="content-area clipped-box" id="app-container">
            <div class="vert-text">Ê©üÂãïÊà¶Â£´„Ç∑„Çπ„ÉÜ„É†</div>

            <!-- DASHBOARD -->
            <div id="app-dashboard" class="app-view">
                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--accent); padding-bottom: 10px;">
                    <div><h3>SYSTEM READY</h3><span class="jp-sub">„Ç∑„Çπ„ÉÜ„É†Ê∫ñÂÇôÂÆå‰∫Ü</span></div>
                </div>
                <div style="flex-grow: 1; display: flex; justify-content: center; align-items: center; flex-direction: column;">
                    <div style="width: 200px; height: 200px; border: 2px dashed var(--accent); border-radius: 50%; display: flex; justify-content: center; align-items: center; animation: rotate-slow 10s linear infinite;">
                        <div style="font-size: 3rem; font-weight: bold;">STANDBY</div>
                    </div>
                    <p style="margin-top: 20px; font-family: var(--font-display);">Welcome, User.</p>
                </div>
            </div>

            <!-- PROFILE EDITOR -->
            <div id="app-profile" class="app-view hidden">
                <h3 style="border-bottom: 1px solid var(--accent); padding-bottom: 5px;">EDIT IDENTITY // <span class="jp-sub">„Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ</span></h3>
                <div style="max-width: 500px; margin: 20px auto; background: var(--bg-color); padding: 20px; border: 1px solid var(--accent);">
                    <div class="id-input-group"><label>CODENAME</label><input type="text" id="edit-username"></div>
                    <div class="id-input-group"><label>AVATAR URL</label><input type="text" id="edit-avatar"><div style="margin-top:5px; font-size: 0.8em; color: var(--text-dim);">Preview:</div><img id="edit-avatar-preview" src="" style="width: 50px; height: 50px; border-radius: 50%; border: 1px solid var(--accent); display: block; margin-top: 5px;"></div>
                    <div class="id-input-group"><label>BIO</label><textarea id="edit-bio" rows="4"></textarea></div>
                    <div style="margin-bottom: 15px; font-family: monospace; color: var(--text-dim);">DETECTED DEVICE TYPE: <span id="edit-device-display" style="font-weight: bold; color: var(--text-main);">SCANNING...</span></div>
                    <button class="action-btn" onclick="updateProfile()">UPDATE RECORD</button>
                    <button class="action-btn" style="background:var(--alert);border-color:var(--alert);margin-top:10px;" onclick="doLogout()">LOGOUT</button>
                    <p id="edit-status" style="margin-top: 10px; color: green; display: none;">PROFILE UPDATED SUCCESSFULLY</p>
                </div>
            </div>

            <!-- CHAT -->
            <div id="app-chat" class="app-view hidden">
                <h3 style="border-bottom: 1px solid var(--accent); padding-bottom: 5px; margin-bottom: 5px;">MESSENGER LINK // <span class="jp-sub">„É°„ÉÉ„Çª„É≥„Ç∏„É£„Éº</span></h3>
                <div class="chat-container" id="chat-feed">
                    <div style="text-align: center; color: var(--text-dim); font-size: 0.8rem; margin-top: 20px;">ESTABLISHING SECURE CONNECTION...</div>
                </div>
                <div class="chat-controls">
                    <!-- Sticker Modal -->
                    <div id="sticker-modal">
                        <div class="sticker-header">
                            <span>STICKERS</span>
                            <button onclick="document.getElementById('sticker-modal').classList.remove('active')" style="background:none;border:none;cursor:pointer;">X</button>
                        </div>
                        <div class="sticker-grid" id="sticker-grid"></div>
                        <div class="sticker-actions">
                            <input type="file" id="create-sticker-input" accept="image/*" style="display:none;" onchange="handleStickerCreate(this)">
                            <button class="action-btn" style="width:100%;font-size:0.8rem;" onclick="document.getElementById('create-sticker-input').click()">+ CREATE NEW</button>
                        </div>
                    </div>

                    <button class="chat-upload-btn" onclick="toggleStickerModal()" title="Stickers" style="margin-right:5px;">‚ò∫</button>
                    
                    <!-- File Input -->
                    <input type="file" id="chat-file-general" style="display:none;" onchange="window.handleChatFile(this)">
                    <button class="chat-upload-btn" onclick="document.getElementById('chat-file-general').click()" title="Send File" style="margin-right:5px;">üìé</button>

                    <!-- Image Input -->
                    <input type="file" id="chat-file-input" accept="image/*" style="display: none;" onchange="window.handleChatImage(this)">
                    <button class="chat-upload-btn" onclick="document.getElementById('chat-file-input').click()" title="Send Photo">üì∑</button>
                    
                    <input type="text" id="chat-input" placeholder="Type a message..." disabled>
                    
                    <!-- Voice Mic -->
                    <button id="chat-mic-btn" class="chat-mic-btn" onclick="toggleRecord()" title="Hold/Click to Record">üé§</button>
                    
                    <button id="chat-btn" class="chat-send-btn" onclick="sendChat()" disabled>‚û§</button>
                </div>
            </div>

            <!-- VOX (VDO.Ninja - Discord Style) -->
            <div id="app-voice" class="app-view hidden">
                <h3 style="border-bottom: 1px solid var(--accent); padding-bottom: 5px; margin-bottom: 5px;">VOX ROOMS // <span class="jp-sub">Èü≥Â£∞ÂÆ§</span></h3>
                <div class="voice-wrapper">
                    <!-- Channel Sidebar -->
                    <div class="voice-sidebar">
                        <div class="voice-channel-item" onclick="joinChannel('GENERAL')"><span></span> GENERAL</div>
                        <div class="voice-channel-item" onclick="joinChannel('TACTICAL')"><span></span> TACTICAL</div>
                        <div class="voice-channel-item" onclick="joinChannel('OPS')"><span></span> OPS</div>
                        <div class="voice-channel-item" style="margin-top:auto; font-style:italic;" onclick="let r=prompt('Room Name:'); if(r) joinChannel(r.toUpperCase().replace(/\s/g,'_'))">+ CUSTOM</div>
                    </div>
                    
                    <!-- Main Stage -->
                    <div class="voice-main">
                        <div id="voice-stage" class="voice-stage">
                            <div class="voice-placeholder">
                                <div style="font-size: 2rem;">NO SIGNAL</div>
                                <div style="font-size: 0.8rem;">SELECT A FREQUENCY TO CONNECT</div>
                            </div>
                        </div>
                        <!-- Controls Bar -->
                        <div class="voice-controls">
                            <button class="voice-btn" title="Toggle Mic" onclick="toggleIframeMic()">üé§</button>
                            <button class="voice-btn" title="Toggle Audio" onclick="toggleIframeAudio()">üéß</button>
                            <button class="voice-btn" title="Toggle Cam" onclick="toggleIframeCam()">üì∑</button>
                            <button class="voice-btn danger" title="Disconnect" onclick="leaveChannel()">X</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STANDARD APPS -->
            <div id="app-notepad" class="app-view hidden"><div style="display: flex; justify-content: space-between; align-items: center;"><h3>SECURE NOTES (CLOUD)</h3><button class="action-btn" onclick="saveNotes()">SAVE TO CLOUD</button></div><textarea id="notepad-area" placeholder="TYPE DATA HERE..."></textarea></div>
            <div id="app-code" class="app-view hidden"><h3>PYTHON TERMINAL</h3><div class="code-controls"><input type="text" id="filename-input" value="script"><button class="action-btn" onclick="downloadCode()">DL .PY</button></div><textarea id="code-editor" spellcheck="false"></textarea></div>
            <div id="app-music" class="app-view hidden"><h3>SONIC ANALYZER</h3><div class="viz-container"><div id="song-name" class="song-title">NO SIGNAL</div><canvas id="viz-canvas"></canvas></div><div class="viz-controls"><input type="file" id="audio-upload" accept="audio/*" onchange="handleAudio(this)"><audio id="audio-player" controls style="width: 100%;"></audio></div></div>
            <div id="app-paint" class="app-view hidden"><h3>IMAGE EDITOR</h3><div class="paint-toolbar"><input type="file" id="img-upload" accept="image/*" onchange="loadImage(this)"><input type="color" id="brush-color" value="#ff0000"><input type="range" id="brush-size" min="1" max="20" value="3"><button class="action-btn" onclick="setTool('brush')">BRUSH</button><button class="action-btn" onclick="setTool('text')">TEXT</button><button class="action-btn" onclick="clearCanvas()">CLEAR</button><button class="action-btn" onclick="downloadCanvas()">SAVE</button></div><div class="canvas-wrapper" id="canvas-wrapper"><canvas id="paint-canvas"></canvas></div></div>
            <div id="app-links" class="app-view hidden"><div style="display: flex; gap: 10px;"><input type="text" id="link-title" placeholder="TITLE"><input type="text" id="link-url" placeholder="URL"><button class="action-btn" onclick="addLink()">ADD</button></div><div id="link-container" class="link-grid"></div></div>
            <div id="app-calc" class="app-view hidden"><h3>CALCULATOR</h3><div style="flex-grow: 1; display: flex; align-items: center;"><div class="calc-wrapper"><div class="calc-screen" id="calc-display">0</div><div class="calc-grid"><button class="calc-btn" onclick="calcInput('7')">7</button><button class="calc-btn" onclick="calcInput('8')">8</button><button class="calc-btn" onclick="calcInput('9')">9</button><button class="calc-btn op" onclick="calcInput('/')">/</button><button class="calc-btn" onclick="calcInput('4')">4</button><button class="calc-btn" onclick="calcInput('5')">5</button><button class="calc-btn" onclick="calcInput('6')">6</button><button class="calc-btn op" onclick="calcInput('*')">*</button><button class="calc-btn" onclick="calcInput('1')">1</button><button class="calc-btn" onclick="calcInput('2')">2</button><button class="calc-btn" onclick="calcInput('3')">3</button><button class="calc-btn op" onclick="calcInput('-')">-</button><button class="calc-btn" onclick="calcInput('0')">0</button><button class="calc-btn" onclick="calcInput('.')">.</button><button class="calc-btn op" onclick="calcInput('C')">C</button><button class="calc-btn op" onclick="calcInput('+')">+</button><button class="calc-btn eq" style="grid-column: span 4;" onclick="calcRes()">EXECUTE</button></div></div></div></div>
            <div id="app-piano" class="app-view hidden"><h3>SYNTHESIZER</h3><div class="piano-wrapper" id="piano-keys"></div></div>
        </main>

        <aside class="right-panel">
            <div class="stat-card"><h3>MEMORY <span>RAM</span></h3><div class="progress-bar"><div class="fill" style="width: 45%;"></div></div><div style="text-align: right; font-size: 0.8rem; margin-top: 5px;">45% USED</div></div>
            <div class="stat-card"><h3>CPU LOAD <span>CORE</span></h3><div class="progress-bar"><div class="fill" style="width: 82%; animation-duration: 0.5s;"></div></div><div style="text-align: right; font-size: 0.8rem; margin-top: 5px;">82% CRITICAL</div></div>
            <div class="stat-card" style="flex-grow: 1; display: flex; flex-direction: column;"><h3>MODULES</h3><ul style="list-style: none; padding: 0; font-size: 0.8rem; margin-top: 10px;"><li style="display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding: 5px 0;"><span>KERNEL</span><span>[OK]</span></li><li style="display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding: 5px 0;"><span>IDENTITY</span><span>[OK]</span></li><li style="display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding: 5px 0;"><span>COMMS</span><span>[OK]</span></li></ul><div class="barcode" style="margin-top: auto;"></div></div>
        </aside>

        <div class="bottom-bar">
            <div class="log-terminal" id="sys-log">> SYSTEM BOOT V11.19... OK<br>> MODULES LOADED... 10<br><span class="blink">_</span></div>
            <div class="warning-box"><div style="font-size: 2rem;">‚ö†</div><div>WARNING // BIOHAZARD</div><div class="jp-sub" style="color: var(--alert);">ÁîüÁâ©Â≠¶ÁöÑÂç±Èô∫</div></div>
            <div style="display: flex; flex-direction: column; justify-content: space-between; height: 100%; border: 1px solid var(--accent); padding: 10px; background: var(--panel-bg);"><div style="font-size: 0.7rem;">PROJECT: ZENX<br>ID: 599-20-X</div><div style="flex-grow: 1; text-align: right; font-weight: bold;">V.11.19</div></div>
        </div>
    </div>

    <!-- MAIN APP SCRIPT -->
    <script>
        // --- DEVICE DETECTION ---
        function getDeviceType() {
            const ua = navigator.userAgent;
            if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) return "TABLET";
            if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) return "MOBILE";
            return "PC";
        }

        // --- VIEW MODE ---
        window.setViewMode = function(mode) {
            const body = document.body;
            if(mode === 'mobile') {
                body.classList.add('mobile-mode');
                document.getElementById('btn-pc').classList.remove('active');
                document.getElementById('btn-mobile').classList.add('active');
                setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
            } else {
                body.classList.remove('mobile-mode');
                document.getElementById('btn-mobile').classList.remove('active');
                document.getElementById('btn-pc').classList.add('active');
                setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
            }
        }

        // --- THEME TOGGLE ---
        window.toggleTheme = function() {
            document.body.classList.toggle('dark-theme');
            const btn = document.getElementById('btn-theme');
            if(document.body.classList.contains('dark-theme')) {
                btn.innerText = "MODO CLARO";
                localStorage.setItem('zenx_theme', 'dark');
            } else {
                btn.innerText = "MODO OSCURO";
                localStorage.setItem('zenx_theme', 'light');
            }
        }

        // --- BOOT ---
        window.addEventListener('load', () => {
            const bootLog = document.getElementById('boot-log');
            const device = getDeviceType();
            const msgs = ["> BIOS CHECK... OK", "> LOADING KERNEL...", "> DETECTING HARDWARE...", `> DEVICE_TYPE: [${device}]`, "> DECRYPTING KEYS...", "> CONNECTING TO TOKYO-3...", "> ACCESS GRANTED"];
            let delay = 300;
            msgs.forEach(msg => { setTimeout(() => { bootLog.innerHTML += msg + "<br>"; bootLog.scrollTop = bootLog.scrollHeight; }, delay); delay += Math.random() * 500; });
            setTimeout(() => { document.getElementById('boot-overlay').classList.add('loaded'); }, 3000); 
            setTimeout(() => { document.getElementById('boot-overlay').style.display = 'none'; }, 4000);
            if(device === 'MOBILE') setViewMode('mobile');
            
            // Check stored theme
            if(localStorage.getItem('zenx_theme') === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('btn-theme').innerText = "MODO CLARO";
            }
            loadStickers();
        });

        // --- CLOCK ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerHTML = `<div style="font-size:0.5em; color:var(--text-dim)">${now.toLocaleDateString('es-ES')}</div>${now.toLocaleTimeString('es-ES', { hour12: false })}`;
        }, 1000);

        // --- NAVIGATION ---
        window.showApp = function(appId) {
            document.querySelectorAll('.app-view').forEach(el => el.classList.add('hidden'));
            document.getElementById('app-' + appId).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            const map = ['dashboard','profile','chat','voice','notepad','code','music','paint','links','calc','piano'];
            const idx = map.indexOf(appId);
            if(idx >= 0) document.querySelectorAll('.nav-btn')[idx].classList.add('active');
            
            logSystem(`SWITCHING MODULE >> ${appId.toUpperCase()}`);
            if (appId === 'paint') setTimeout(resizePaint, 50);
        }

        function logSystem(msg) {
            const term = document.getElementById('sys-log');
            if(term) term.innerHTML = `> ${msg}<br>` + term.innerHTML;
        }

        // --- STICKER LOGIC ---
        let stickers = [];

        function loadStickers() {
            stickers = JSON.parse(localStorage.getItem('zenx_stickers') || '[]');
            // Add default dummy sticker if empty
            if(stickers.length === 0) {
               stickers.push("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSI1Ii8+PGNpcmNsZSBjeD0iMzUiIGN5PSIzNSIgcj0iNSIvPjxjaXJjbGUgY3g9IjY1IiBjeT0iMzUiIHI9IjUiLz48cGF0aCBkPSJNMzUgNjUgazMwIiBzdHJva2U9ImJsYWNrIiBzdHJva2Utd2lkdGg9IjUiIGZpbGw9Im5vbmUiLz48L3N2Zz4="); 
            }
            renderStickerGrid();
        }

        function renderStickerGrid() {
            const grid = document.getElementById('sticker-grid');
            grid.innerHTML = '';
            stickers.forEach(s => {
                const img = document.createElement('img');
                img.src = s;
                img.className = 'sticker-option';
                img.onclick = () => {
                    sendStickerMessage(s);
                    document.getElementById('sticker-modal').classList.remove('active');
                };
                grid.appendChild(img);
            });
        }

        window.toggleStickerModal = function() {
            document.getElementById('sticker-modal').classList.toggle('active');
        }

        window.handleStickerCreate = async function(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if(file.size > 2 * 1024 * 1024) { alert("Image too large"); return; }
                
                try {
                    // Resize to 150x150 for sticker
                    const compressed = await compressImageToSize(file, 150);
                    stickers.push(compressed);
                    localStorage.setItem('zenx_stickers', JSON.stringify(stickers));
                    renderStickerGrid();
                    alert("Sticker created!");
                } catch(e) { console.error(e); }
                input.value = '';
            }
        }

        window.saveStickerToLibrary = function(base64) {
            if(!stickers.includes(base64)) {
                stickers.push(base64);
                localStorage.setItem('zenx_stickers', JSON.stringify(stickers));
                renderStickerGrid();
                alert("Sticker saved to collection!");
            } else {
                alert("You already have this sticker.");
            }
        }

        function compressImageToSize(file, maxSize) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        let width = img.width; let height = img.height;
                        if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } 
                        else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                        canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); 
                        resolve(canvas.toDataURL('image/webp', 0.8));
                    }; img.onerror = (e) => reject(e);
                }; reader.onerror = (e) => reject(e);
            });
        }

        // --- VDO.NINJA VOICE ROOMS LOGIC ---
        let currentVoiceWindow = null;

        window.joinChannel = function(channelName) {
            const stage = document.getElementById('voice-stage');
            stage.innerHTML = '';
            
            // Visual feedback
            document.querySelectorAll('.voice-channel-item').forEach(btn => btn.classList.remove('active'));
            const items = document.querySelectorAll('.voice-channel-item');
            for(let item of items) {
                if(item.innerText.includes(channelName)) item.classList.add('active');
            }

            // Setup VDO.Ninja Iframe
            const username = document.getElementById('edit-username').value || 'Agent';
            const roomID = 'zenx_os_' + channelName.toLowerCase();
            
            // Parameters for Mesh mode (Discord Style)
            const iframeUrl = `https://vdo.ninja/?room=${roomID}&label=${encodeURIComponent(username)}&mesh&transparent&clean&darkmode&autostart`;

            const iframe = document.createElement('iframe');
            iframe.src = iframeUrl;
            iframe.id = "voice-iframe";
            iframe.allow = "camera; microphone; display-capture; autoplay; fullscreen";
            
            stage.appendChild(iframe);
            currentVoiceWindow = iframe.contentWindow;
            logSystem(`VOX LINK ESTABLISHED >> [${channelName}]`);
        }

        window.leaveChannel = function() {
            document.getElementById('voice-stage').innerHTML = '<div class="voice-placeholder"><div style="font-size: 2rem;">NO SIGNAL</div><div style="font-size: 0.8rem;">SELECT A FREQUENCY TO CONNECT</div></div>';
            document.querySelectorAll('.voice-channel-item').forEach(btn => btn.classList.remove('active'));
            currentVoiceWindow = null;
            logSystem("VOX LINK TERMINATED");
        }

        window.toggleIframeMic = function() { alert("Use on-screen controls inside the video feed."); }
        window.toggleIframeAudio = function() { alert("Use on-screen controls inside the video feed."); }
        window.toggleIframeCam = function() { alert("Use on-screen controls inside the video feed."); }


        // --- STANDARD APPS LOGIC ---
        const notepad = document.getElementById('notepad-area');
        if(localStorage.getItem('zenx_notes')) notepad.value = localStorage.getItem('zenx_notes');
        notepad.addEventListener('input', () => localStorage.setItem('zenx_notes', notepad.value));
        // Save to cloud logic added in module
        
        const codeEditor = document.getElementById('code-editor');
        codeEditor.addEventListener('keydown', function(e) {
            if (e.key == 'Tab') { e.preventDefault(); var s = this.selectionStart; this.value = this.value.substring(0, s) + "    " + this.value.substring(this.selectionEnd); this.selectionStart = this.selectionEnd = s + 4; }
        });
        window.downloadCode = function() {
            const blob = new Blob([codeEditor.value], {type: "text/x-python"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${document.getElementById('filename-input').value || 'script'}.py`; a.click();
        };

        let audioCtx, analyser, audioSource, isVizRunning = false;
        const audioPlayer = document.getElementById('audio-player');
        const vizCanvas = document.getElementById('viz-canvas');
        const vizCtx = vizCanvas.getContext('2d');
        audioPlayer.addEventListener('play', () => {
            if(!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); analyser = audioCtx.createAnalyser(); analyser.fftSize = 256; audioSource = audioCtx.createMediaElementSource(audioPlayer); audioSource.connect(analyser); analyser.connect(audioCtx.destination); }
            if(audioCtx.state === 'suspended') audioCtx.resume();
            if(!isVizRunning) { isVizRunning = true; drawViz(); }
        });
        window.handleAudio = function(input) {
            if(input.files[0]) { document.getElementById('song-name').innerText = input.files[0].name; audioPlayer.src = URL.createObjectURL(input.files[0]); audioPlayer.play().catch(()=>{}); }
        };
        function drawViz() {
            if(!isVizRunning) return; requestAnimationFrame(drawViz);
            if(vizCanvas.width !== vizCanvas.parentElement.offsetWidth) { vizCanvas.width = vizCanvas.parentElement.offsetWidth; vizCanvas.height = vizCanvas.parentElement.offsetHeight; }
            const buffer = analyser.frequencyBinCount; const data = new Uint8Array(buffer); analyser.getByteFrequencyData(data);
            vizCtx.fillStyle = '#000'; vizCtx.fillRect(0, 0, vizCanvas.width, vizCanvas.height);
            const w = (vizCanvas.width / buffer) * 2.5; let x = 0;
            for(let i = 0; i < buffer; i++) { const h = data[i]; vizCtx.fillStyle = `rgb(${h + 25}, ${i * 2}, 50)`; vizCtx.fillRect(x, vizCanvas.height - h, w, h); x += w + 1; }
        }

        const pCanvas = document.getElementById('paint-canvas');
        const pCtx = pCanvas.getContext('2d');
        let painting = false, currentTool = 'brush', loadedImg = null;
        window.resizePaint = function() { const wrap = document.getElementById('canvas-wrapper'); pCanvas.width = wrap.offsetWidth; pCanvas.height = wrap.offsetHeight; if(loadedImg) drawImageToCanvas(loadedImg); };
        window.addEventListener('resize', () => { if(!document.getElementById('app-paint').classList.contains('hidden')) resizePaint(); });
        window.loadImage = function(input) { if(input.files[0]) { const r = new FileReader(); r.onload = function(e) { loadedImg = new Image(); loadedImg.onload = function() { resizePaint(); drawImageToCanvas(loadedImg); }; loadedImg.src = e.target.result; }; r.readAsDataURL(input.files[0]); } };
        function drawImageToCanvas(img) { const s = Math.min(pCanvas.width / img.width, pCanvas.height / img.height); const x = (pCanvas.width / 2) - (img.width / 2) * s; const y = (pCanvas.height / 2) - (img.height / 2) * s; pCtx.clearRect(0,0,pCanvas.width, pCanvas.height); pCtx.drawImage(img, x, y, img.width * s, img.height * s); }
        pCanvas.addEventListener('mousedown', (e) => { painting = true; if(currentTool === 'text') { const t = prompt("Enter text:", "Sample Text"); if(t) { const rect = pCanvas.getBoundingClientRect(); pCtx.fillStyle = document.getElementById('brush-color').value; pCtx.font = "30px 'Share Tech Mono'"; pCtx.fillText(t, e.clientX - rect.left, e.clientY - rect.top); } painting = false; } else { draw(e); } });
        pCanvas.addEventListener('mouseup', () => { painting = false; pCtx.beginPath(); });
        pCanvas.addEventListener('mousemove', draw);
        function draw(e) { if(!painting || currentTool === 'text') return; const rect = pCanvas.getBoundingClientRect(); pCtx.lineWidth = document.getElementById('brush-size').value; pCtx.lineCap = 'round'; pCtx.strokeStyle = document.getElementById('brush-color').value; pCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top); pCtx.stroke(); pCtx.beginPath(); pCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top); }
        window.setTool = function(t) { currentTool = t; }; window.clearCanvas = function() { pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height); loadedImg = null; }; window.downloadCanvas = function() { const l = document.createElement('a'); l.download = 'zenx.png'; l.href = pCanvas.toDataURL(); l.click(); };

        function loadLinks() { const links = JSON.parse(localStorage.getItem('zenx_links') || '[]'); const c = document.getElementById('link-container'); c.innerHTML = ''; links.forEach((l, i) => { const b = document.createElement('a'); b.className = 'link-btn clipped-box'; b.href = l.url; b.target = '_blank'; b.innerHTML = `<div>${l.title}</div><div style="font-size:0.7em">${new URL(l.url).hostname}</div>`; const d = document.createElement('div'); d.className = 'link-del'; d.innerText = 'X'; d.onclick = (e) => { e.preventDefault(); links.splice(i, 1); localStorage.setItem('zenx_links', JSON.stringify(links)); loadLinks(); }; b.appendChild(d); c.appendChild(b); }); }
        window.addLink = function() { const t = document.getElementById('link-title').value; let u = document.getElementById('link-url').value; if(t && u) { if(!u.startsWith('http')) u = 'https://' + u; const l = JSON.parse(localStorage.getItem('zenx_links') || '[]'); l.push({title: t, url: u}); localStorage.setItem('zenx_links', JSON.stringify(l)); loadLinks(); document.getElementById('link-title').value = ''; document.getElementById('link-url').value = ''; } }; loadLinks();

        let calcVal = ''; window.calcInput = function(v) { if(v==='C') calcVal=''; else calcVal+=v; document.getElementById('calc-display').innerText = calcVal || '0'; }; window.calcRes = function() { try { calcVal = eval(calcVal).toString(); document.getElementById('calc-display').innerText = calcVal; } catch { document.getElementById('calc-display').innerText = 'ERR'; calcVal=''; } };

        let pianoCtx; function playNote(f, el) { if(!pianoCtx) pianoCtx = new (window.AudioContext || window.webkitAudioContext)(); if(pianoCtx.state==='suspended') pianoCtx.resume(); el.classList.add('active'); setTimeout(()=>el.classList.remove('active'), 200); const o = pianoCtx.createOscillator(); const g = pianoCtx.createGain(); o.type='sawtooth'; o.frequency.value = f; o.connect(g); g.connect(pianoCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.00001, pianoCtx.currentTime + 1); o.stop(pianoCtx.currentTime + 1); }
        const notes = [{n:'C',f:261.63},{n:'C#',f:277.18,b:true},{n:'D',f:293.66},{n:'D#',f:311.13,b:true},{n:'E',f:329.63},{n:'F',f:349.23},{n:'F#',f:369.99,b:true},{n:'G',f:392.00},{n:'G#',f:415.30,b:true},{n:'A',f:440.00},{n:'A#',f:466.16,b:true},{n:'B',f:493.88},{n:'C2',f:523.25}];
        const pc = document.getElementById('piano-keys'); notes.forEach(n => { const k = document.createElement('div'); k.className = `key ${n.b?'black':''}`; if(!n.b) k.innerHTML = `<div class="key-label">${n.n}</div>`; k.onmousedown = () => playNote(n.f, k); pc.appendChild(k); });

        setInterval(() => { const c = document.querySelector('.blink'); c.style.opacity = c.style.opacity === '0' ? '1' : '0'; }, 500);
        window.closeProfileModal = function(e) { document.getElementById('profile-modal').classList.remove('active'); };
    </script>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const customFirebaseConfig = {
          apiKey: "AIzaSyAyqd2AQNBYhCZfPo7VvOfY50PdIZsWRqs",
          authDomain: "shirochat-68f95.firebaseapp.com",
          projectId: "shirochat-68f95",
          storageBucket: "shirochat-68f95.firebasestorage.app",
          messagingSenderId: "50906823525",
          appId: "1:50906823525:web:abf7f2cc1c1e64f0133f8c",
          measurementId: "G-P8WHHKFL7Z"
        };

        const windowConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : null;
        const firebaseConfig = customFirebaseConfig || windowConfig;
        
        let app, auth, db;
        let currentUser = null;
        let userProfilesCache = {}; 
        const appId = window.__app_id || 'default-app-id';

        async function initSystem() {
            if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
                try {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            currentUser = user;
                            console.log("LOGGED IN AS", user.uid);
                            updateNetStatus(true);
                            document.getElementById('chat-input').disabled = false;
                            document.getElementById('chat-btn').disabled = false;
                            checkProfileExistence();
                            initListeners();
                            
                            // Load Cloud Notes if user is real
                            if(!user.isAnonymous) loadCloudNotes();
                        } else {
                            // If no user, try anonymous fallback
                            signInAnonymously(auth).catch(e => console.error(e));
                        }
                    });

                } catch (e) { console.error("Firebase Init Failed", e); updateNetStatus(false, "AUTH FAIL"); }
            } else { console.error("No Firebase Config detected"); updateNetStatus(false, "NO CONFIG"); }
        }

        window.loginWithGoogle = async function() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Login Error", error);
                alert("Google Login Failed: " + error.message + "\nMake sure your domain is authorized in Firebase Console.");
            }
        }

        window.doLogout = async function() {
            await signOut(auth);
            location.reload();
        }

        function updateNetStatus(connected, msg) {
            const el = document.getElementById('net-status');
            if (connected) { el.innerText = "CONNECTED"; el.style.color = "#00aa00"; } else { el.innerText = msg || "DISCONNECTED"; el.style.color = "#ff2a2a"; document.getElementById('chat-input').disabled = true; document.getElementById('chat-btn').disabled = true; }
        }

        async function checkProfileExistence() {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', currentUser.uid);
            try {
                const docSnap = await getDoc(docRef);
                
                // Auto-fill from Google if available
                let googleData = {};
                if (!currentUser.isAnonymous) {
                    googleData = {
                        username: currentUser.displayName,
                        avatar: currentUser.photoURL,
                        isVerified: true
                    };
                }

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Update verification if Google user
                    if(!currentUser.isAnonymous && !data.isVerified) {
                        await updateDoc(docRef, { isVerified: true });
                    }
                    
                    document.getElementById('edit-username').value = data.username;
                    document.getElementById('edit-avatar').value = data.avatar;
                    document.getElementById('edit-bio').value = data.bio;
                    document.getElementById('edit-avatar-preview').src = data.avatar;
                    document.getElementById('edit-device-display').innerText = data.device || 'UNKNOWN';
                } else {
                    // New Profile
                    if (!currentUser.isAnonymous) {
                        // Create profile silently for Google users
                        await setDoc(docRef, {
                            username: googleData.username,
                            avatar: googleData.avatar,
                            bio: "Verified Google Operator",
                            device: window.getDeviceType(),
                            uid: currentUser.uid,
                            isVerified: true,
                            timestamp: Date.now()
                        });
                        // Refresh UI
                        document.getElementById('identity-overlay').classList.remove('active');
                        document.getElementById('edit-username').value = googleData.username;
                        document.getElementById('edit-avatar').value = googleData.avatar;
                        document.getElementById('edit-avatar-preview').src = googleData.avatar;
                    } else {
                        document.getElementById('manual-reg-btn').style.display = 'block';
                        setTimeout(() => { document.getElementById('identity-overlay').classList.add('active'); }, 3500);
                    }
                }
            } catch(e) { console.error(e); }
        }

        window.registerUser = async function() {
            if (!currentUser) return;
            const username = document.getElementById('reg-username').value;
            const avatar = document.getElementById('reg-avatar').value;
            const bio = document.getElementById('reg-bio').value;
            const deviceType = window.getDeviceType();
            if (!username || !avatar) return;
            
            const profileData = { 
                username, avatar, bio, device: deviceType, uid: currentUser.uid, timestamp: Date.now(),
                isVerified: !currentUser.isAnonymous // Trust Google users
            };
            
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', currentUser.uid), profileData);
                document.getElementById('identity-overlay').classList.remove('active');
                document.getElementById('manual-reg-btn').style.display = 'none';
                document.getElementById('edit-username').value = username;
                document.getElementById('edit-avatar').value = avatar;
                document.getElementById('edit-bio').value = bio;
                document.getElementById('edit-device-display').innerText = deviceType;
            } catch (e) { alert("REGISTRATION ERROR: " + e.message); }
        }

        window.updateProfile = async function() {
            if (!currentUser) return;
            const username = document.getElementById('edit-username').value;
            const avatar = document.getElementById('edit-avatar').value;
            const bio = document.getElementById('edit-bio').value;
            const updateData = { username, avatar, bio, uid: currentUser.uid, timestamp: Date.now() };
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', currentUser.uid), updateData, { merge: true });
                const status = document.getElementById('edit-status');
                status.style.display = 'block';
                setTimeout(() => status.style.display = 'none', 3000);
            } catch (e) { alert("ERROR: " + e.message); }
        }

        // --- CLOUD NOTES ---
        window.saveNotes = async function() {
            const noteContent = document.getElementById('notepad-area').value;
            // Local save always
            const blob = new Blob([noteContent], {type: "text/plain"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'zenx_notes.txt'; a.click();
            
            // Cloud Save if Google User
            if(currentUser && !currentUser.isAnonymous) {
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notes', currentUser.uid), {
                        content: noteContent,
                        updated: Date.now()
                    });
                    alert("Notes Synced to Cloud Account!");
                } catch(e) { console.error(e); }
            } else {
                alert("Notes saved locally. Login with Google to sync to cloud.");
            }
        }

        async function loadCloudNotes() {
            try {
                const docSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notes', currentUser.uid));
                if(docSnap.exists()) {
                    document.getElementById('notepad-area').value = docSnap.data().content;
                }
            } catch(e) { console.error("Note sync error", e); }
        }

        function initListeners() {
            if (!currentUser) return;
            const profilesRef = collection(db, 'artifacts', appId, 'public', 'data', 'profiles');
            onSnapshot(profilesRef, (snapshot) => { snapshot.forEach(doc => userProfilesCache[doc.id] = doc.data()); });
            const chatRef = collection(db, 'artifacts', appId, 'public', 'data', 'chat');
            onSnapshot(chatRef, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    messages.push(data);
                });
                messages.sort((a, b) => a.timestamp - b.timestamp);
                renderChat(messages);
                markMessagesAsRead(messages);
            });
        }

        function markMessagesAsRead(messages) {
            const unread = messages.filter(m => m.uid !== currentUser.uid && (!m.readBy || !m.readBy.includes(currentUser.uid)));
            const toUpdate = unread.slice(-20); 
            toUpdate.forEach(msg => {
                const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'chat', msg.id);
                updateDoc(msgRef, {
                    readBy: arrayUnion(currentUser.uid)
                }).catch(e => console.log("Read receipt error (harmless)", e));
            });
        }

        function renderChat(messages) {
            const feed = document.getElementById('chat-feed');
            if(!feed) return;
            feed.innerHTML = '';
            messages.forEach(msg => {
                const row = document.createElement('div');
                row.className = 'chat-row';
                const isSelf = (msg.uid === currentUser?.uid);
                if(isSelf) row.classList.add('self'); else row.classList.add('other');
                const profile = userProfilesCache[msg.uid] || { username: msg.user || 'UNKNOWN', avatar: 'https://api.dicebear.com/7.x/bottts/svg?seed=' + msg.uid, bio: 'No bio available.', uid: msg.uid, device: 'UNKNOWN' };
                
                const avatar = document.createElement('div'); 
                avatar.className = 'chat-avatar-small'; 
                avatar.style.backgroundImage = `url('${profile.avatar}')`; 
                avatar.title = "View Profile"; 
                avatar.onclick = (e) => openProfileModal(profile);
                
                const contentGroup = document.createElement('div'); 
                contentGroup.className = 'chat-msg-content';
                
                const date = new Date(msg.timestamp); 
                const timeStr = date.toLocaleTimeString('es-ES', {hour12: false, hour: '2-digit', minute:'2-digit'});
                let devTag = "[UNK]"; if(profile.device === 'MOBILE' || profile.device === 'TABLET') devTag = "üì±"; else if(profile.device === 'PC') devTag = "üíª";
                
                // Verified Badge Logic
                let verifiedBadge = profile.isVerified ? '<span class="verified-badge">[‚òÖ]</span>' : '';

                const meta = document.createElement('div'); 
                meta.className = 'chat-meta'; 
                
                let readCountHtml = '';
                if(isSelf && msg.readBy && msg.readBy.length > 0) {
                    readCountHtml = `<span class="read-receipt active" title="Seen by ${msg.readBy.length}">üëÅÔ∏è ${msg.readBy.length}</span>`;
                }
                
                meta.innerHTML = `${devTag} ${verifiedBadge} ${profile.username} ‚Ä¢ ${timeStr} ${readCountHtml}`;
                
                const bubble = document.createElement('div'); 
                bubble.className = 'chat-bubble';
                
                if (msg.type === 'sticker') {
                    bubble.classList.add('sticker-msg');
                    const img = document.createElement('img');
                    img.src = msg.image;
                    img.className = 'chat-sticker';
                    img.title = "Double click to save sticker";
                    img.ondblclick = () => window.saveStickerToLibrary(msg.image);
                    img.onload = () => feed.scrollTop = feed.scrollHeight;
                    bubble.appendChild(img);
                } else if (msg.type === 'audio') {
                    // AUDIO PLAYER
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = msg.audio;
                    audio.className = 'chat-audio-player';
                    bubble.appendChild(audio);
                } else if (msg.type === 'file') {
                    // FILE CARD
                    const fileLink = document.createElement('a');
                    fileLink.href = msg.fileData;
                    fileLink.download = msg.fileName;
                    fileLink.className = 'chat-file-card';
                    fileLink.innerHTML = `<span class="chat-file-icon">üìÑ</span><div class="chat-file-info"><div>${msg.fileName}</div><div style="font-size:0.7em;opacity:0.7">CLICK TO DOWNLOAD</div></div>`;
                    bubble.appendChild(fileLink);
                } else {
                    // IMAGE & TEXT
                    if (msg.image) { 
                        const img = document.createElement('img'); 
                        img.src = msg.image; 
                        img.className = 'chat-image'; 
                        img.onclick = () => showImageViewer(msg.image);
                        img.onload = () => feed.scrollTop = feed.scrollHeight; 
                        bubble.appendChild(img); 
                    }
                    if (msg.text) { 
                        const txt = document.createElement('div'); 
                        // Linkify Text
                        txt.innerHTML = linkify(msg.text); 
                        if(msg.edited) txt.innerHTML += ' <span style="font-size:0.7em;color:#888;font-style:italic;">(edited)</span>';
                        bubble.appendChild(txt); 
                    }
                }

                if (msg.reactions) {
                    const reactionBar = document.createElement('div');
                    reactionBar.className = 'reaction-bar';
                    const counts = {};
                    Object.values(msg.reactions).forEach(emoji => {
                        counts[emoji] = (counts[emoji] || 0) + 1;
                    });
                    
                    Object.keys(counts).forEach(emoji => {
                        const pill = document.createElement('div');
                        pill.className = 'reaction-pill';
                        pill.innerText = `${emoji} ${counts[emoji]}`;
                        reactionBar.appendChild(pill);
                    });
                    contentGroup.appendChild(reactionBar);
                }

                if (isSelf || !isSelf) { 
                    const actionsDiv = document.createElement('div');
                    actionsDiv.style.position = "absolute";
                    actionsDiv.style.top = "-10px";
                    actionsDiv.style.right = isSelf ? "auto" : "-25px";
                    actionsDiv.style.left = isSelf ? "-25px" : "auto";
                    actionsDiv.style.display = "flex";
                    actionsDiv.style.flexDirection = "column";
                    
                    const optsBtn = document.createElement('button');
                    optsBtn.className = 'msg-options-btn';
                    optsBtn.innerHTML = '‚ãÆ';
                    optsBtn.onclick = (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.msg-options-menu').forEach(m => m.classList.remove('active'));
                        const menu = actionsDiv.querySelector('.msg-options-menu');
                        menu.classList.toggle('active');
                    };
                    
                    const menu = document.createElement('div');
                    menu.className = 'msg-options-menu';
                    
                    const reactOpt = document.createElement('div');
                    reactOpt.className = 'msg-option';
                    reactOpt.innerText = '‚ò∫ React';
                    reactOpt.onclick = () => openReactionPicker(msg.id);
                    menu.appendChild(reactOpt);

                    if (isSelf) {
                        const editOpt = document.createElement('div');
                        editOpt.className = 'msg-option';
                        editOpt.innerText = '‚úé Edit';
                        editOpt.onclick = () => editMessage(msg.id, msg.text);
                        menu.appendChild(editOpt);

                        const delOpt = document.createElement('div');
                        delOpt.className = 'msg-option delete';
                        delOpt.innerText = 'üóë Delete';
                        delOpt.onclick = () => deleteMessage(msg.id);
                        menu.appendChild(delOpt);
                    }

                    actionsDiv.appendChild(optsBtn);
                    actionsDiv.appendChild(menu);
                    contentGroup.appendChild(actionsDiv);
                }

                contentGroup.appendChild(meta); 
                contentGroup.appendChild(bubble); 
                
                if (isSelf) { row.appendChild(contentGroup); row.appendChild(avatar); } else { row.appendChild(avatar); row.appendChild(contentGroup); }
                feed.appendChild(row);
            });
            feed.scrollTop = feed.scrollHeight;
        }

        // --- NEW FEATURES HELPER FUNCTIONS ---

        function linkify(inputText) {
            if(!inputText) return "";
            var replacedText, replacePattern1, replacePattern2, replacePattern3;

            // URLs starting with http://, https://, or ftp://
            replacePattern1 = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
            replacedText = inputText.replace(replacePattern1, '<a href="$1" class="chat-link" target="_blank">$1</a>');

            // URLs starting with "www." (without // before it, or it'd re-link the ones done above).
            replacePattern2 = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
            replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" class="chat-link" target="_blank">$2</a>');

            return replacedText;
        }

        // AUDIO RECORDER
        let mediaRecorder;
        let audioChunks = [];

        window.toggleRecord = async function() {
            const btn = document.getElementById('chat-mic-btn');
            
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = e => {
                        audioChunks.push(e.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = async () => {
                            const base64Audio = reader.result;
                            await sendAudioMessage(base64Audio);
                        };
                    };
                    
                    btn.classList.add('recording');
                } catch(e) {
                    alert("Mic Error: " + e.message);
                }
            } else {
                mediaRecorder.stop();
                btn.classList.remove('recording');
            }
        }

        async function sendAudioMessage(base64Audio) {
            if(!currentUser) return;
            const myProfile = userProfilesCache[currentUser.uid] || {};
            const msgData = { 
                text: "", 
                type: "audio",
                audio: base64Audio,
                user: myProfile.username || 'GHOST', 
                uid: currentUser.uid, 
                timestamp: Date.now(), 
                readBy: [] 
            };
            try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), msgData); } catch (e) { alert("TX ERROR: " + e.message); }
        }

        // GENERIC FILE HANDLER
        window.handleChatFile = function(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if(file.size > 1024 * 1024) { // 1MB Limit for Firestore Document size constraint
                    alert("File too large (Max 1MB). Firestore limit."); 
                    return; 
                }
                
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async (e) => {
                    const base64File = e.target.result;
                    await sendFileMessage(base64File, file.name);
                };
                input.value = '';
            }
        }

        async function sendFileMessage(base64File, fileName) {
            if(!currentUser) return;
            const myProfile = userProfilesCache[currentUser.uid] || {};
            const msgData = { 
                text: "", 
                type: "file",
                fileData: base64File,
                fileName: fileName,
                user: myProfile.username || 'GHOST', 
                uid: currentUser.uid, 
                timestamp: Date.now(), 
                readBy: [] 
            };
            try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), msgData); } catch (e) { alert("TX ERROR: " + e.message); }
        }

        // --- EXISTING UTILS ---

        document.addEventListener('click', (e) => {
            if(!e.target.closest('.msg-options-btn')) {
                document.querySelectorAll('.msg-options-menu').forEach(m => m.classList.remove('active'));
            }
        });
        
        window.deleteMessage = async function(msgId) {
            if(confirm("Delete this message?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chat', msgId));
                } catch(e) { alert("Error deleting: " + e.message); }
            }
        }

        window.editMessage = async function(msgId, oldText) {
            const newText = prompt("Edit message:", oldText);
            if(newText !== null && newText !== oldText) {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chat', msgId), {
                        text: newText,
                        edited: true
                    });
                } catch(e) { alert("Error editing: " + e.message); }
            }
        }

        let currentMsgIdForReaction = null;
        window.openReactionPicker = function(msgId) {
            currentMsgIdForReaction = msgId;
            document.getElementById('reaction-picker').classList.add('active');
        }

        window.submitReaction = async function(emoji) {
            if(!currentMsgIdForReaction) return;
            const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'chat', currentMsgIdForReaction);
            try {
                const updateField = {};
                updateField[`reactions.${currentUser.uid}`] = emoji;
                await updateDoc(msgRef, updateField);
                document.getElementById('reaction-picker').classList.remove('active');
            } catch(e) { console.error(e); alert("Error reacting"); }
        }

        window.showImageViewer = function(src) {
            const viewer = document.getElementById('image-viewer-modal');
            const img = document.getElementById('image-viewer-img');
            img.src = src;
            viewer.classList.add('active');
        }

        async function sendImageMessage(base64Image) {
            if(!currentUser) return;
            const myProfile = userProfilesCache[currentUser.uid] || {};
            const msgData = { text: "", image: base64Image, user: myProfile.username || 'GHOST', uid: currentUser.uid, timestamp: Date.now(), readBy: [] };
            try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), msgData); } catch (e) { alert("TX ERROR: " + e.message); }
        }

        async function sendStickerMessage(base64Image) {
            if(!currentUser) return;
            const myProfile = userProfilesCache[currentUser.uid] || {};
            const msgData = { text: "", image: base64Image, type: "sticker", user: myProfile.username || 'GHOST', uid: currentUser.uid, timestamp: Date.now(), readBy: [] };
            try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), msgData); } catch (e) { alert("TX ERROR: " + e.message); }
        }
        window.sendStickerMessage = sendStickerMessage;

        window.sendChat = async function() {
            const input = document.getElementById('chat-input');
            const text = input ? input.value : '';
            if(!text.trim() || !currentUser) return;
            const myProfile = userProfilesCache[currentUser.uid] || {};
            const msgData = { text: text, user: myProfile.username || 'GHOST', uid: currentUser.uid, timestamp: Date.now(), readBy: [] };
            try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), msgData); input.value = ''; } catch (e) { alert("TX ERROR: " + e.message); }
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const MAX_SIZE = 800; // Increased size slightly for photos
                        let width = img.width; let height = img.height;
                        if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                        canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', 0.8));
                    }; img.onerror = (e) => reject(e);
                }; reader.onerror = (e) => reject(e);
            });
        }

        window.handleChatImage = async function(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if(file.size > 8 * 1024 * 1024) { alert("Image too large (Max 8MB source)"); return; }
                const btn = document.querySelector('.chat-upload-btn'); const origText = btn.innerText; btn.innerText = "‚è≥"; btn.disabled = true;
                try { const compressedBase64 = await compressImage(file); await sendImageMessage(compressedBase64); } catch (e) { console.error(e); alert("Error processing image"); } finally { btn.innerText = origText; btn.disabled = false; input.value = ''; }
            }
        }

        window.openProfileModal = function(profile) {
            document.getElementById('view-avatar').style.backgroundImage = `url('${profile.avatar}')`; document.getElementById('view-name').innerText = profile.username; document.getElementById('view-id').innerText = profile.uid ? profile.uid.substring(0, 8) : '???'; document.getElementById('view-bio').innerText = profile.bio || "No data."; document.getElementById('view-device').innerText = profile.device || "UNKNOWN"; document.getElementById('profile-modal').classList.add('active');
        }

        const chatInput = document.getElementById('chat-input');
        if(chatInput) { chatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') window.sendChat(); }); }

        initSystem();
    </script>
</body>
</html>